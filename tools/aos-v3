#!/bin/bash

# Agent OS Quick Init Tool (aos) - Version 3
# Version: 3.0.0
# Improved with project-level validation

# Configuration
AGENT_OS_VERSION="3.0.0"
AGENT_OS_REPO="https://github.com/carmandale/agent-os"
AGENT_OS_RAW_URL="https://raw.githubusercontent.com/carmandale/agent-os/main"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Helper function for status messages
print_status() {
    case "$1" in
        "success") echo -e "${GREEN}✅ $2${NC}" ;;
        "warning") echo -e "${YELLOW}⚠️  $2${NC}" ;;
        "error") echo -e "${RED}❌ $2${NC}" ;;
        "info") echo -e "${BLUE}ℹ️  $2${NC}" ;;
        "check") echo -e "${CYAN}🔍 $2${NC}" ;;
        *) echo "$2" ;;
    esac
}

# Check if Agent OS is installed globally
check_global_installation() {
    if [ -d "$HOME/.agent-os/instructions" ] && [ -d "$HOME/.agent-os/standards" ]; then
        return 0
    else
        return 1
    fi
}

# Detect project type (claude, cursor, both, or unknown)
detect_project_type() {
    local has_claude=false
    local has_cursor=false
    
    if [ -f ".claude/claude.json" ] || [ -f "CLAUDE.md" ]; then
        has_claude=true
    fi
    
    if [ -d ".cursor" ] || [ -f ".cursorrules" ]; then
        has_cursor=true
    fi
    
    if [ "$has_claude" = true ] && [ "$has_cursor" = true ]; then
        echo "both"
    elif [ "$has_claude" = true ]; then
        echo "claude"
    elif [ "$has_cursor" = true ]; then
        echo "cursor"
    else
        echo "unknown"
    fi
}

# Check for global updates
check_for_updates() {
    # Quick connectivity check
    if ! curl -s -I "$AGENT_OS_REPO" > /dev/null 2>&1; then
        return 1  # No internet, skip update check
    fi
    
    # Get latest release tag
    local latest_tag=$(curl -s "https://api.github.com/repos/carmandale/agent-os/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    
    # If no releases, we're using main branch
    if [ -z "$latest_tag" ]; then
        echo "main"
        return 0
    fi
    
    # Check installed version
    if [ -f "$HOME/.agent-os/.version" ]; then
        local installed_version=$(cat "$HOME/.agent-os/.version")
        if [ "$installed_version" != "$latest_tag" ]; then
            echo "$latest_tag"  # Return new version available
            return 0
        fi
    fi
    
    echo "current"  # Up to date
    return 0
}

# Check if project setup is current
check_project_currency() {
    local project_type=$(detect_project_type)
    local issues=()
    
    if [ "$project_type" = "unknown" ]; then
        return 0  # No project setup to check
    fi
    
    # Check Claude Code setup
    if [ "$project_type" = "claude" ] || [ "$project_type" = "both" ]; then
        # Check if commands are up to date
        if [ -d "$HOME/.claude/commands" ]; then
            local cmd_count=$(ls ~/.claude/commands/*.md 2>/dev/null | wc -l | tr -d ' ')
            if [ "$cmd_count" -lt "7" ]; then
                issues+=("Claude commands incomplete ($cmd_count/7 files)")
            fi
            
            # Check if commands are recent (modified in last 7 days indicates they're current)
            local old_cmds=$(find ~/.claude/commands -name "*.md" -mtime +30 2>/dev/null | wc -l | tr -d ' ')
            if [ "$old_cmds" -gt "0" ]; then
                issues+=("Claude commands may be outdated (not updated in 30+ days)")
            fi
        else
            issues+=("Claude commands not installed")
        fi
        
        # Check hooks version
        if [ -f "$HOME/.claude/settings.json" ]; then
            if ! grep -q "workflow-enforcement-hook-v2" "$HOME/.claude/settings.json" 2>/dev/null; then
                if grep -q "workflow-enforcement-hook" "$HOME/.claude/settings.json" 2>/dev/null; then
                    issues+=("Claude hooks using old version (v1)")
                else
                    issues+=("Claude hooks not configured")
                fi
            fi
        fi
    fi
    
    # Check Cursor setup
    if [ "$project_type" = "cursor" ] || [ "$project_type" = "both" ]; then
        if [ -d ".cursor/rules" ]; then
            local rule_count=$(ls .cursor/rules/*.mdc 2>/dev/null | wc -l | tr -d ' ')
            if [ "$rule_count" -lt "5" ]; then
                issues+=("Cursor rules incomplete ($rule_count files)")
            fi
        else
            issues+=("Cursor rules not installed in project")
        fi
    fi
    
    # Check Agent OS product documentation
    if [ -d ".agent-os/product" ]; then
        # Check if all required files exist
        local required_files=("mission.md" "roadmap.md" "tech-stack.md" "decisions.md")
        for file in "${required_files[@]}"; do
            if [ ! -f ".agent-os/product/$file" ]; then
                issues+=("Missing product file: $file")
            fi
        done
    fi
    
    # Return issues array
    if [ ${#issues[@]} -eq 0 ]; then
        echo "current"
    else
        printf '%s\n' "${issues[@]}"
    fi
}

# Comprehensive status check
check_comprehensive_status() {
    echo "📊 Agent OS Status Report"
    echo "========================="
    echo ""
    
    # Section 1: Global Installation
    echo "🌍 Global Installation:"
    if check_global_installation; then
        print_status "success" "Installed at ~/.agent-os/"
        
        # Quick file count
        local inst_count=$(ls ~/.agent-os/instructions/*.md 2>/dev/null | wc -l | tr -d ' ')
        local std_count=$(ls ~/.agent-os/standards/*.md 2>/dev/null | wc -l | tr -d ' ')
        echo "   • $inst_count instruction files"
        echo "   • $std_count standard files"
        
        # Check version
        local update_status=$(check_for_updates)
        if [ "$update_status" = "current" ]; then
            local version=$(cat ~/.agent-os/.version 2>/dev/null || echo "unknown")
            print_status "success" "Up to date (version: $version)"
        elif [ "$update_status" = "main" ]; then
            print_status "info" "Using main branch (no releases)"
        elif [ ! -z "$update_status" ]; then
            print_status "warning" "Update available: $update_status"
            echo "   Run 'aos update' to update"
        fi
    else
        print_status "error" "Not installed"
        echo "   Run 'aos' to install"
    fi
    
    echo ""
    
    # Section 2: Project Setup
    echo "📁 Current Project:"
    local project_type=$(detect_project_type)
    
    if [ "$project_type" = "unknown" ]; then
        print_status "info" "No AI assistant detected"
        echo "   Run 'aos init' to set up"
    else
        print_status "success" "Type: $project_type"
        
        # Check project currency
        local project_issues=$(check_project_currency)
        if [ "$project_issues" = "current" ]; then
            print_status "success" "Project setup is current"
            
            # Show what's configured
            if [ "$project_type" = "claude" ] || [ "$project_type" = "both" ]; then
                local cmd_count=$(ls ~/.claude/commands/*.md 2>/dev/null | wc -l | tr -d ' ')
                echo "   • Claude: $cmd_count commands installed"
                
                # Check hook version
                if grep -q "workflow-enforcement-hook-v2" "$HOME/.claude/settings.json" 2>/dev/null; then
                    echo "   • Hooks: v2 (latest)"
                elif grep -q "workflow-enforcement-hook-v3" "$HOME/.claude/settings.json" 2>/dev/null; then
                    echo "   • Hooks: v3 (experimental)"
                fi
            fi
            
            if [ "$project_type" = "cursor" ] || [ "$project_type" = "both" ]; then
                local rule_count=$(ls .cursor/rules/*.mdc 2>/dev/null | wc -l | tr -d ' ')
                echo "   • Cursor: $rule_count rules installed"
            fi
            
            if [ -d ".agent-os/product" ]; then
                echo "   • Product docs: Initialized"
            else
                print_status "info" "Product docs: Not initialized"
                echo "   Use /analyze-product or /plan-product"
            fi
        else
            print_status "warning" "Project setup needs attention:"
            echo "$project_issues" | while IFS= read -r issue; do
                echo "   ⚠️  $issue"
            done
            echo ""
            echo "   Run 'aos init' to fix these issues"
        fi
    fi
    
    echo ""
    
    # Section 3: Quick Actions
    echo "⚡ Quick Actions:"
    
    # Determine what actions are available
    local show_install=false
    local show_update=false
    local show_init=false
    
    if ! check_global_installation; then
        show_install=true
    else
        local update_status=$(check_for_updates)
        if [ "$update_status" != "current" ] && [ "$update_status" != "main" ]; then
            show_update=true
        fi
    fi
    
    if [ "$project_type" = "unknown" ] || [ "$project_issues" != "current" ]; then
        show_init=true
    fi
    
    if [ "$show_install" = true ]; then
        echo "   • Run 'aos' to install Agent OS"
    fi
    if [ "$show_update" = true ]; then
        echo "   • Run 'aos update' to update Agent OS"
    fi
    if [ "$show_init" = true ]; then
        echo "   • Run 'aos init' to set up this project"
    fi
    
    if [ "$show_install" = false ] && [ "$show_update" = false ] && [ "$show_init" = false ]; then
        print_status "success" "Everything is up to date!"
    fi
}

# Smart update that preserves customizations
smart_update() {
    echo ""
    echo "🔄 Agent OS Update"
    echo "=================="
    
    # Check what's customized
    local has_custom_standards=false
    local has_custom_hooks=false
    
    # Check if standards were modified in last 30 days
    if find "$HOME/.agent-os/standards" -type f -mtime -30 2>/dev/null | grep -q .; then
        has_custom_standards=true
        print_status "info" "Detected customized standards (modified in last 30 days)"
    fi
    
    # Check if hooks are v2 or v3
    if [ -f "$HOME/.claude/settings.json" ] && grep -q "workflow-enforcement-hook-v[23]" "$HOME/.claude/settings.json" 2>/dev/null; then
        has_custom_hooks=true
        print_status "info" "Detected custom hook configuration"
    fi
    
    echo ""
    echo "Update options:"
    echo "  1) Smart update (recommended) - Updates core files, preserves customizations"
    echo "  2) Instructions only - Only update workflow instructions"
    echo "  3) Full update - Overwrite everything (backup created)"
    echo "  4) Cancel"
    echo ""
    echo -n "Choice [1-4]: "
    read -r choice
    
    case "$choice" in
        1)  # Smart update
            print_status "info" "Performing smart update..."
            
            # Backup current installation
            if [ -d "$HOME/.agent-os" ]; then
                cp -r "$HOME/.agent-os" "$HOME/.agent-os.backup-$(date +%Y%m%d-%H%M%S)"
                print_status "success" "Backup created"
            fi
            
            # Run update with appropriate flags
            local flags="--overwrite-instructions"
            if [ "$has_custom_standards" = false ]; then
                flags="$flags --overwrite-standards"
            fi
            
            if curl -sSL "$AGENT_OS_RAW_URL/setup.sh" | bash -s -- $flags; then
                print_status "success" "Smart update complete"
                
                # Update hooks if needed
                if [ "$has_custom_hooks" = false ] && [ -f "$HOME/.agent-os/hooks/install-hooks.sh" ]; then
                    print_status "info" "Updating hooks..."
                    "$HOME/.agent-os/hooks/install-hooks.sh" 2>/dev/null
                fi
                
                return 0
            else
                print_status "error" "Update failed - backup available at ~/.agent-os.backup-*"
                return 1
            fi
            ;;
            
        2)  # Instructions only
            print_status "info" "Updating instructions only..."
            if curl -sSL "$AGENT_OS_RAW_URL/setup.sh" | bash -s -- --overwrite-instructions; then
                print_status "success" "Instructions updated"
                return 0
            else
                print_status "error" "Update failed"
                return 1
            fi
            ;;
            
        3)  # Full update
            print_status "warning" "Full update will overwrite all customizations"
            echo -n "Are you sure? (y/n): "
            read -r confirm
            if [[ "$confirm" == "y" ]]; then
                # Backup first
                if [ -d "$HOME/.agent-os" ]; then
                    cp -r "$HOME/.agent-os" "$HOME/.agent-os.backup-$(date +%Y%m%d-%H%M%S)"
                    print_status "success" "Backup created"
                fi
                
                if curl -sSL "$AGENT_OS_RAW_URL/setup.sh" | bash -s -- --overwrite-instructions --overwrite-standards; then
                    print_status "success" "Full update complete"
                    return 0
                else
                    print_status "error" "Update failed - backup available"
                    return 1
                fi
            else
                print_status "info" "Update cancelled"
                return 1
            fi
            ;;
            
        *)
            print_status "info" "Update cancelled"
            return 1
            ;;
    esac
}

# Quick project setup with validation
quick_setup_project() {
    local project_type=$(detect_project_type)
    local project_issues=$(check_project_currency)
    
    # Show current status
    if [ "$project_type" != "unknown" ] && [ "$project_issues" != "current" ]; then
        print_status "warning" "Project needs updates:"
        echo "$project_issues" | while IFS= read -r issue; do
            echo "   ⚠️  $issue"
        done
        echo ""
    fi
    
    # If type unknown, ask once
    if [ "$project_type" = "unknown" ]; then
        echo ""
        echo "Which AI assistant will you use?"
        echo "  1) Claude Code"
        echo "  2) Cursor"
        echo "  3) Both"
        echo "  4) Skip"
        echo -n "Choice [1-4]: "
        read -r choice
        
        case "$choice" in
            1) project_type="claude" ;;
            2) project_type="cursor" ;;
            3) project_type="both" ;;
            *) return 1 ;;
        esac
    fi
    
    # Setup based on type
    case "$project_type" in
        "claude"|"both")
            print_status "info" "Setting up Claude Code..."
            # Check if hooks should be skipped
            local skip_hooks=""
            if [ -f "$HOME/.claude/settings.json" ] && grep -q "workflow-enforcement-hook" "$HOME/.claude/settings.json" 2>/dev/null; then
                skip_hooks="--skip-hooks"
            fi
            
            if curl -sSL "$AGENT_OS_RAW_URL/setup-claude-code.sh" | bash -s -- $skip_hooks 2>/dev/null; then
                print_status "success" "Claude Code ready"
            else
                print_status "error" "Claude Code setup failed"
            fi
            
            if [ "$project_type" = "both" ]; then
                print_status "info" "Setting up Cursor..."
                if curl -sSL "$AGENT_OS_RAW_URL/setup-cursor.sh" | bash 2>/dev/null; then
                    print_status "success" "Cursor ready"
                else
                    print_status "error" "Cursor setup failed"
                fi
            fi
            ;;
            
        "cursor")
            print_status "info" "Setting up Cursor..."
            if curl -sSL "$AGENT_OS_RAW_URL/setup-cursor.sh" | bash 2>/dev/null; then
                print_status "success" "Cursor ready"
            else
                print_status "error" "Cursor setup failed"
            fi
            ;;
    esac
    
    # Verify setup
    echo ""
    print_status "check" "Verifying project setup..."
    local new_issues=$(check_project_currency)
    if [ "$new_issues" = "current" ]; then
        print_status "success" "Project setup complete and current!"
    else
        print_status "warning" "Some issues remain - manual intervention may be needed"
    fi
    
    # Quick tips
    echo ""
    echo "Quick start commands:"
    if [ "$project_type" = "claude" ] || [ "$project_type" = "both" ]; then
        echo "  Claude: /analyze-product (for existing code) or /plan-product (for new)"
    fi
    if [ "$project_type" = "cursor" ] || [ "$project_type" = "both" ]; then
        echo "  Cursor: @analyze-product (for existing code) or @plan-product (for new)"
    fi
}

# Main menu - streamlined with better validation
main_menu() {
    # Quick validation
    local global_ok=false
    local project_ok=false
    
    if check_global_installation; then
        global_ok=true
        local update_status=$(check_for_updates)
        if [ "$update_status" != "current" ] && [ "$update_status" != "main" ] && [ ! -z "$update_status" ]; then
            print_status "warning" "Agent OS update available: $update_status"
        else
            print_status "success" "Agent OS is up to date"
        fi
    else
        print_status "warning" "Agent OS not installed"
    fi
    
    local project_type=$(detect_project_type)
    local project_issues=$(check_project_currency)
    if [ "$project_type" != "unknown" ]; then
        if [ "$project_issues" = "current" ]; then
            project_ok=true
            print_status "success" "Project setup is current"
        else
            print_status "warning" "Project setup needs updates"
        fi
    else
        print_status "info" "No project setup detected"
    fi
    
    # Show menu
    echo ""
    echo "What would you like to do?"
    
    if [ "$global_ok" = false ]; then
        echo "  1) Install Agent OS"
    elif [ "$project_ok" = false ]; then
        echo "  1) Setup/fix project"
    else
        echo "  1) Verify project setup"
    fi
    
    echo "  2) Update Agent OS"
    echo "  3) Full status report"
    echo "  4) Exit"
    echo ""
    echo -n "Choice [1-4]: "
    read -r choice
    
    case "$choice" in
        1) 
            if [ "$global_ok" = false ]; then
                # Install Agent OS
                if curl -sSL "$AGENT_OS_RAW_URL/setup.sh" | bash; then
                    print_status "success" "Installation complete!"
                    quick_setup_project
                fi
            else
                # Setup or verify project
                quick_setup_project
            fi
            ;;
        2) smart_update ;;
        3) check_comprehensive_status ;;
        *) print_status "info" "Goodbye!" ;;
    esac
}

# Command line interface
case "${1:-}" in
    "init")
        if ! check_global_installation; then
            print_status "info" "Installing Agent OS first..."
            curl -sSL "$AGENT_OS_RAW_URL/setup.sh" | bash
        fi
        quick_setup_project
        ;;
    "update")
        smart_update
        ;;
    "status"|"check")
        check_comprehensive_status
        ;;
    "help"|"--help"|"-h")
        echo "aos - Agent OS Quick Setup v3"
        echo ""
        echo "Usage: aos [command]"
        echo ""
        echo "Commands:"
        echo "  init     Setup/fix Agent OS in current project"
        echo "  update   Smart update Agent OS"
        echo "  status   Comprehensive status report"
        echo "  help     Show this help"
        echo ""
        echo "No command runs interactive mode"
        ;;
    "")
        # Interactive mode
        echo "🚀 Agent OS Quick Setup"
        echo "======================="
        echo ""
        main_menu
        ;;
    *)
        print_status "error" "Unknown command: $1"
        echo "Run 'aos help' for usage"
        exit 1
        ;;
esac